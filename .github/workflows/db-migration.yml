# TruePulse Database Migration Pipeline
# Runs database migrations against Azure PostgreSQL via Container App revision deployment
#
# How it works:
# 1. Triggers a new revision with RUN_MIGRATION env var set to the script name
# 2. The docker-entrypoint.sh detects this and runs the migration before starting the app
# 3. Once migration completes, the app starts normally
# 4. Logs are captured for verification
#
# Usage:
# - Manual trigger with migration script selection
# - Can also be called from deploy workflow for automatic migrations

name: Database Migration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      migration_script:
        description: 'Migration script to run (in src/backend/scripts/)'
        required: true
        type: choice
        options:
          - migrate_to_passkey_only.py
          - add_distributed_locks.py
          - add_polls_composite_indexes.py
          - add_ad_tracking.py
          - add_new_demographics.py
          - add_poll_types_and_community.py
          - add_theme_preference.py
          - custom
      custom_script:
        description: 'Custom script path (only if migration_script is "custom")'
        required: false
        type: string
  
  # Allow calling from other workflows
  workflow_call:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: string
      migration_script:
        description: 'Migration script to run'
        required: true
        type: string
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true

permissions:
  id-token: write
  contents: read

env:
  AZURE_LOCATION: eastus2

jobs:
  migrate:
    name: Run Migration
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v6

      - name: Validate inputs
        run: |
          SCRIPT="${{ inputs.migration_script }}"
          CUSTOM="${{ inputs.custom_script }}"
          
          if [ "$SCRIPT" == "custom" ] && [ -z "$CUSTOM" ]; then
            echo "Error: custom_script is required when migration_script is 'custom'"
            exit 1
          fi
          
          if [ "$SCRIPT" != "custom" ]; then
            SCRIPT_NAME="$SCRIPT"
          else
            SCRIPT_NAME=$(basename "$CUSTOM")
          fi
          
          echo "SCRIPT_NAME=$SCRIPT_NAME" >> $GITHUB_ENV
          echo "Will run migration script: $SCRIPT_NAME"

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set environment variables
        run: |
          ENV="${{ inputs.environment }}"
          echo "RESOURCE_GROUP=rg-truepulse-${ENV}" >> $GITHUB_ENV
          echo "CONTAINER_APP=ca-truepulse-api-${ENV}" >> $GITHUB_ENV

      - name: Verify Container App exists
        run: |
          echo "Verifying Container App: ${{ env.CONTAINER_APP }}"
          
          az containerapp show \
            --name "${{ env.CONTAINER_APP }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --query "name" \
            -o tsv || {
              echo "Error: Container App not found"
              exit 1
            }
          
          echo "✅ Container App verified"

      - name: Deploy migration revision
        id: deploy-migration
        run: |
          echo "=========================================="
          echo "Deploying migration revision"
          echo "Script: ${{ env.SCRIPT_NAME }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "=========================================="
          
          # Get current revision for rollback reference
          CURRENT_REVISION=$(az containerapp revision list \
            --name "${{ env.CONTAINER_APP }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --query "[?properties.active==\`true\`].name | [0]" \
            -o tsv)
          
          echo "Current revision: $CURRENT_REVISION"
          echo "ROLLBACK_REVISION=$CURRENT_REVISION" >> $GITHUB_ENV
          
          # Deploy with migration env var
          echo ""
          echo "Setting RUN_MIGRATION=${{ env.SCRIPT_NAME }}"
          
          az containerapp update \
            --name "${{ env.CONTAINER_APP }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --set-env-vars "RUN_MIGRATION=${{ env.SCRIPT_NAME }}" \
            --min-replicas 1 \
            --max-replicas 1 \
            --query "properties.latestRevisionName" \
            -o tsv > new_revision.txt
          
          NEW_REVISION=$(cat new_revision.txt)
          echo "Migration revision: $NEW_REVISION"
          echo "NEW_REVISION=$NEW_REVISION" >> $GITHUB_ENV

      - name: Wait for migration to complete
        run: |
          echo "Waiting for revision to be ready..."
          
          # Wait for the new revision to be running
          for i in {1..30}; do
            STATUS=$(az containerapp revision show \
              --name "${{ env.CONTAINER_APP }}" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --revision "${{ env.NEW_REVISION }}" \
              --query "properties.runningState" \
              -o tsv 2>/dev/null || echo "Unknown")
            
            echo "Attempt $i/30: Revision status = $STATUS"
            
            if [ "$STATUS" == "Running" ]; then
              echo "✅ Revision is running"
              break
            elif [ "$STATUS" == "Failed" ] || [ "$STATUS" == "Degraded" ]; then
              echo "❌ Revision failed to start!"
              exit 1
            fi
            
            sleep 10
          done
          
          # Give the migration script time to execute
          echo ""
          echo "Waiting for migration script to execute (60 seconds)..."
          sleep 60

      - name: Get migration logs
        id: get-logs
        run: |
          echo "=========================================="
          echo "Fetching migration logs"
          echo "=========================================="
          
          # Get logs from the Container App
          az containerapp logs show \
            --name "${{ env.CONTAINER_APP }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --type console \
            --tail 300 \
            --follow false 2>&1 | tee migration_logs.txt || {
              echo "Warning: Could not fetch logs via CLI"
            }
          
          echo ""
          echo "Log output saved to migration_logs.txt"
          
          # Check for success/failure markers in logs
          if grep -q "Migration completed successfully\|✅" migration_logs.txt 2>/dev/null; then
            echo ""
            echo "✅ Migration appears successful based on logs"
            echo "MIGRATION_SUCCESS=true" >> $GITHUB_ENV
          elif grep -q "already exists" migration_logs.txt 2>/dev/null; then
            echo ""
            echo "✅ Migration skipped - table/index already exists"
            echo "MIGRATION_SUCCESS=true" >> $GITHUB_ENV
          elif grep -q "Migration failed\|❌\|Error\|Exception" migration_logs.txt 2>/dev/null; then
            echo ""
            echo "⚠️ Potential migration failure detected"
            echo "MIGRATION_SUCCESS=false" >> $GITHUB_ENV
          else
            echo ""
            echo "⚠️ Could not determine migration status from logs"
            echo "MIGRATION_SUCCESS=unknown" >> $GITHUB_ENV
          fi

      - name: Clear migration env var
        if: always()
        run: |
          echo "Clearing RUN_MIGRATION environment variable..."
          
          az containerapp update \
            --name "${{ env.CONTAINER_APP }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --remove-env-vars "RUN_MIGRATION" \
            --query "properties.latestRevisionName" \
            -o tsv || echo "Warning: Could not clear env var"
          
          echo "✅ Environment variable cleared"

      - name: Verify application health
        run: |
          echo "Waiting for app to stabilize..."
          sleep 30
          
          # Get the Container App FQDN
          FQDN=$(az containerapp show \
            --name "${{ env.CONTAINER_APP }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --query "properties.configuration.ingress.fqdn" \
            -o tsv)
          
          echo "Checking health endpoint: https://$FQDN/health"
          
          for i in {1..10}; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "https://$FQDN/health" 2>/dev/null || echo "000")
            
            if [ "$RESPONSE" == "200" ]; then
              echo "✅ Container App is healthy"
              exit 0
            fi
            
            echo "Attempt $i/10: HTTP $RESPONSE, waiting..."
            sleep 10
          done
          
          echo "⚠️ Health check did not return 200 after 10 attempts"
          echo "The migration may still have succeeded - please verify manually"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: migration-logs-${{ inputs.environment }}-${{ github.run_number }}
          path: |
            migration_logs.txt
            new_revision.txt
          retention-days: 30
          if-no-files-found: ignore

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "Migration Summary"
          echo "=========================================="
          echo "Script: ${{ env.SCRIPT_NAME }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "Migration Revision: ${{ env.NEW_REVISION }}"
          echo "Status: ${{ env.MIGRATION_SUCCESS || 'unknown' }}"
          echo "=========================================="
          
          if [ "${{ env.MIGRATION_SUCCESS }}" == "false" ]; then
            echo ""
            echo "⚠️ Migration may have failed. Please check the logs artifact."
            exit 1
          fi
