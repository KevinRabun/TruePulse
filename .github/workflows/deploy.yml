# TruePulse Deployment Pipeline
# Deploys infrastructure and applications to Azure
# Only runs after CI workflow succeeds

name: Deploy

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write
  contents: read

env:
  AZURE_LOCATION: eastus2

jobs:
  # ============================================================================
  # Verify CI Success (for workflow_run trigger)
  # ============================================================================
  check-ci:
    name: Verify CI Passed
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - run: echo "CI workflow succeeded, proceeding with deployment"

  # ============================================================================
  # Determine Environment
  # ============================================================================
  setup:
    name: Setup
    runs-on: ubuntu-latest
    needs: check-ci
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
    steps:
      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # Deploy Infrastructure
  # ============================================================================
  infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: setup
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      resourceGroupName: ${{ steps.deploy.outputs.resourceGroupName }}
      acrLoginServer: ${{ steps.deploy.outputs.acrLoginServer }}
      apiFqdn: ${{ steps.deploy.outputs.apiFqdn }}
      swaHostname: ${{ steps.deploy.outputs.swaHostname }}
      keyVaultUri: ${{ steps.deploy.outputs.keyVaultUri }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Bicep
        id: deploy
        run: |
          DEPLOYMENT_OUTPUT=$(az deployment sub create \
            --location ${{ env.AZURE_LOCATION }} \
            --template-file infra/main.bicep \
            --parameters environmentName=${{ needs.setup.outputs.environment }} \
            --parameters postgresAdminUsername='truepulseadmin' \
            --parameters postgresAdminPassword='${{ secrets.POSTGRES_PASSWORD }}' \
            --parameters jwtSecretKey='${{ secrets.JWT_SECRET_KEY }}' \
            --parameters voteHashSecret='${{ secrets.VOTE_HASH_SECRET }}' \
            --parameters newsDataApiKey='${{ secrets.NEWSDATA_API_KEY }}' \
            --parameters newsApiOrgKey='${{ secrets.NEWSAPI_ORG_KEY }}' \
            --parameters communicationSenderNumber='${{ secrets.COMMUNICATION_SENDER_NUMBER }}' \
            --parameters enableCMK=true \
            --query 'properties.outputs' \
            --output json)
          
          echo "resourceGroupName=$(echo $DEPLOYMENT_OUTPUT | jq -r '.resourceGroupName.value')" >> $GITHUB_OUTPUT
          echo "acrLoginServer=$(echo $DEPLOYMENT_OUTPUT | jq -r '.containerRegistryLoginServer.value')" >> $GITHUB_OUTPUT
          echo "apiFqdn=$(echo $DEPLOYMENT_OUTPUT | jq -r '.containerAppApiFqdn.value')" >> $GITHUB_OUTPUT
          echo "swaHostname=$(echo $DEPLOYMENT_OUTPUT | jq -r '.staticWebAppHostname.value')" >> $GITHUB_OUTPUT
          echo "keyVaultUri=$(echo $DEPLOYMENT_OUTPUT | jq -r '.keyVaultUri.value')" >> $GITHUB_OUTPUT

      - name: Save SWA Deployment Token to Key Vault
        run: |
          # Get the SWA deployment token
          SWA_NAME=$(az resource list \
            --resource-group ${{ steps.deploy.outputs.resourceGroupName }} \
            --resource-type Microsoft.Web/staticSites \
            --query '[0].name' -o tsv)
          
          SWA_TOKEN=$(az staticwebapp secrets list \
            --name $SWA_NAME \
            --resource-group ${{ steps.deploy.outputs.resourceGroupName }} \
            --query 'properties.apiKey' -o tsv)
          
          # Store in Key Vault
          KV_NAME=$(az keyvault list \
            --resource-group ${{ steps.deploy.outputs.resourceGroupName }} \
            --query '[0].name' -o tsv)
          
          az keyvault secret set \
            --vault-name $KV_NAME \
            --name swa-deployment-token \
            --value "$SWA_TOKEN"

  # ============================================================================
  # Build and Push Backend Container
  # ============================================================================
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: [setup, infrastructure]
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      imageTag: ${{ steps.meta.outputs.tags }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: |
          az acr login --name ${{ needs.infrastructure.outputs.acrLoginServer }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ needs.infrastructure.outputs.acrLoginServer }}/truepulse-api
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: src/backend
          file: src/backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            ENVIRONMENT=${{ needs.setup.outputs.environment }}

  # ============================================================================
  # Deploy Backend to Container Apps
  # ============================================================================
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: [setup, infrastructure, build-backend]
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Container Apps
        run: |
          IMAGE_TAG=$(echo "${{ needs.build-backend.outputs.imageTag }}" | head -1)
          
          az containerapp update \
            --name ca-truepulse-api \
            --resource-group ${{ needs.infrastructure.outputs.resourceGroupName }} \
            --image $IMAGE_TAG

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to complete..."
          sleep 30
          
          # Check container app status
          STATUS=$(az containerapp show \
            --name ca-truepulse-api \
            --resource-group ${{ needs.infrastructure.outputs.resourceGroupName }} \
            --query 'properties.runningStatus' -o tsv)
          
          if [ "$STATUS" != "Running" ]; then
            echo "Deployment failed. Status: $STATUS"
            exit 1
          fi
          
          echo "Deployment successful!"

      - name: Health check
        run: |
          API_URL="https://${{ needs.infrastructure.outputs.apiFqdn }}"
          
          for i in {1..10}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/health" || echo "000")
            if [ "$HTTP_STATUS" == "200" ]; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $i: HTTP status $HTTP_STATUS, retrying in 10s..."
            sleep 10
          done
          
          echo "Health check failed after 10 attempts"
          exit 1

  # ============================================================================
  # Build and Deploy Frontend
  # ============================================================================
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [setup, infrastructure, deploy-backend]
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/frontend/package-lock.json

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get SWA Deployment Token
        id: swa-token
        run: |
          KV_NAME=$(az keyvault list \
            --resource-group ${{ needs.infrastructure.outputs.resourceGroupName }} \
            --query '[0].name' -o tsv)
          
          TOKEN=$(az keyvault secret show \
            --vault-name $KV_NAME \
            --name swa-deployment-token \
            --query 'value' -o tsv)
          
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          cd src/frontend
          npm ci

      - name: Build frontend
        env:
          NEXT_PUBLIC_API_URL: https://${{ needs.infrastructure.outputs.apiFqdn }}
        run: |
          cd src/frontend
          npm run build

      - name: Deploy to Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa-token.outputs.token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'src/frontend'
          output_location: 'out'
          skip_app_build: true

  # ============================================================================
  # Run Database Migrations
  # ============================================================================
  run-migrations:
    name: Run Migrations
    runs-on: ubuntu-latest
    needs: [setup, infrastructure, deploy-backend]
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Run Alembic Migrations
        run: |
          # Execute migration command in container
          az containerapp exec \
            --name ca-truepulse-api \
            --resource-group ${{ needs.infrastructure.outputs.resourceGroupName }} \
            --command "alembic upgrade head"

  # ============================================================================
  # Post-Deployment Tests
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [setup, infrastructure, deploy-backend, deploy-frontend, run-migrations]
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: |
          pip install httpx pytest

      - name: Run integration tests
        env:
          API_URL: https://${{ needs.infrastructure.outputs.apiFqdn }}
          FRONTEND_URL: https://${{ needs.infrastructure.outputs.swaHostname }}
        run: |
          # Basic API health check
          curl -f "$API_URL/health"
          
          # Basic frontend check
          curl -f "$FRONTEND_URL" | grep -q "TruePulse"
          
          echo "Integration tests passed!"

  # ============================================================================
  # Deployment Complete
  # ============================================================================
  deploy-complete:
    name: Deployment Complete
    runs-on: ubuntu-latest
    needs:
      - setup
      - infrastructure
      - build-backend
      - deploy-backend
      - deploy-frontend
      - run-migrations
      - integration-tests
    steps:
      - name: Deployment summary
        run: |
          echo "## Deployment Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** https://${{ needs.infrastructure.outputs.apiFqdn }}" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend URL:** https://${{ needs.infrastructure.outputs.swaHostname }}" >> $GITHUB_STEP_SUMMARY
