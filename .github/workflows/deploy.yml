# TruePulse Deployment Pipeline
# Two-phase deployment: shared resources then environment-specific resources
# Only runs after CI workflow succeeds

name: Deploy

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write
  contents: read

env:
  AZURE_LOCATION: eastus2

jobs:
  # ============================================================================
  # Verify CI Success (for workflow_run trigger)
  # ============================================================================
  check-ci:
    name: Verify CI Passed
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - run: echo "CI workflow succeeded, proceeding with deployment"

  # ============================================================================
  # Determine Environment
  # ============================================================================
  setup:
    name: Setup
    runs-on: ubuntu-latest
    needs: check-ci
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
    steps:
      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # Deploy Shared Resources (ACR, Communication Services, Log Analytics, DNS)
  # Always runs - Azure deployments are idempotent
  # ============================================================================
  shared-infrastructure:
    name: Deploy Shared Resources
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      logAnalyticsWorkspaceId: ${{ steps.deploy-shared.outputs.logAnalyticsWorkspaceId }}
      containerRegistryName: ${{ steps.deploy-shared.outputs.containerRegistryName }}
      containerRegistryLoginServer: ${{ steps.deploy-shared.outputs.containerRegistryLoginServer }}
      communicationServiceName: ${{ steps.deploy-shared.outputs.communicationServiceName }}
      communicationServiceConnectionString: ${{ steps.deploy-shared.outputs.communicationServiceConnectionString }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Shared Bicep
        id: deploy-shared
        run: |
          echo "Deploying shared resources..."
          
          # Deploy and capture outputs directly from deployment
          DEPLOYMENT_OUTPUT=$(az deployment sub create \
            --name "shared-$(date +%Y%m%d%H%M%S)" \
            --location ${{ env.AZURE_LOCATION }} \
            --template-file infra/shared.bicep \
            --parameters location=${{ env.AZURE_LOCATION }} \
            --query 'properties.outputs' \
            --output json)
          
          echo "Deployment outputs:"
          echo "$DEPLOYMENT_OUTPUT" | jq .
          
          # Extract values from deployment outputs
          LOG_ANALYTICS_ID=$(echo "$DEPLOYMENT_OUTPUT" | jq -r '.logAnalyticsWorkspaceId.value // empty')
          ACR_NAME=$(echo "$DEPLOYMENT_OUTPUT" | jq -r '.containerRegistryName.value // empty')
          ACR_LOGIN=$(echo "$DEPLOYMENT_OUTPUT" | jq -r '.containerRegistryLoginServer.value // empty')
          ACS_NAME=$(echo "$DEPLOYMENT_OUTPUT" | jq -r '.communicationServiceName.value // empty')
          
          echo "=== Extracted Values ==="
          echo "Log Analytics ID: $LOG_ANALYTICS_ID"
          echo "ACR Name: $ACR_NAME"
          echo "ACR Login: $ACR_LOGIN"
          echo "ACS Name: $ACS_NAME"
          echo "========================="
          
          # Validate Log Analytics ID
          if [ -z "$LOG_ANALYTICS_ID" ]; then
            echo "ERROR: Failed to get Log Analytics Workspace ID from deployment outputs!"
            echo "Trying to fetch from Azure directly..."
            LOG_ANALYTICS_ID=$(az monitor log-analytics workspace list \
              --resource-group rg-truepulse-shared \
              --query '[0].id' -o tsv 2>/dev/null || echo "")
            echo "Fetched Log Analytics ID: $LOG_ANALYTICS_ID"
          fi
          
          # Write outputs using proper escaping for multiline/special chars
          {
            echo "logAnalyticsWorkspaceId=$LOG_ANALYTICS_ID"
            echo "containerRegistryName=$ACR_NAME"
            echo "containerRegistryLoginServer=$ACR_LOGIN"
            echo "communicationServiceName=$ACS_NAME"
          } >> $GITHUB_OUTPUT
          
          # Get Communication Service connection string (not in Bicep outputs)
          ACS_CONN=$(az communication list-key --name "$ACS_NAME" --resource-group rg-truepulse-shared --query 'primaryConnectionString' -o tsv)
          echo "communicationServiceConnectionString=$ACS_CONN" >> $GITHUB_OUTPUT
          
          echo "=== Final outputs written ==="
          cat $GITHUB_OUTPUT

  # ============================================================================
  # Deploy Environment Infrastructure
  # ============================================================================
  infrastructure:
    name: Deploy ${{ needs.setup.outputs.environment }} Infrastructure
    runs-on: ubuntu-latest
    needs: [setup, shared-infrastructure]
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      resourceGroupName: ${{ steps.deploy.outputs.resourceGroupName }}
      acrLoginServer: ${{ steps.deploy.outputs.acrLoginServer }}
      apiFqdn: ${{ steps.deploy.outputs.apiFqdn }}
      swaHostname: ${{ steps.deploy.outputs.swaHostname }}
      keyVaultUri: ${{ steps.deploy.outputs.keyVaultUri }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Display Shared Resource Values
        id: shared
        run: |
          # Use outputs from shared-infrastructure job
          LOG_ID="${{ needs.shared-infrastructure.outputs.logAnalyticsWorkspaceId }}"
          ACR_NAME="${{ needs.shared-infrastructure.outputs.containerRegistryName }}"
          ACR_LOGIN="${{ needs.shared-infrastructure.outputs.containerRegistryLoginServer }}"
          ACS_NAME="${{ needs.shared-infrastructure.outputs.communicationServiceName }}"
          ACS_CONN="${{ needs.shared-infrastructure.outputs.communicationServiceConnectionString }}"
          
          # Debug output
          echo "=== Shared Resource Values ==="
          echo "Log Analytics ID: $LOG_ID"
          echo "ACR Name: $ACR_NAME"
          echo "ACR Login: $ACR_LOGIN"
          echo "ACS Name: $ACS_NAME"
          echo "==============================="
          
          # Validate required values
          if [ -z "$LOG_ID" ]; then
            echo "ERROR: Log Analytics Workspace ID is empty!"
            exit 1
          fi
          
          echo "logAnalyticsWorkspaceId=$LOG_ID" >> $GITHUB_OUTPUT
          echo "containerRegistryName=$ACR_NAME" >> $GITHUB_OUTPUT
          echo "containerRegistryLoginServer=$ACR_LOGIN" >> $GITHUB_OUTPUT
          echo "communicationServiceName=$ACS_NAME" >> $GITHUB_OUTPUT
          echo "communicationServiceConnectionString=$ACS_CONN" >> $GITHUB_OUTPUT

      - name: Deploy Environment Bicep
        id: deploy
        run: |
          echo "Deploying ${{ needs.setup.outputs.environment }} environment..."
          echo "Using Log Analytics: ${{ steps.shared.outputs.logAnalyticsWorkspaceId }}"
          
          DEPLOYMENT_OUTPUT=$(az deployment sub create \
            --name "${{ needs.setup.outputs.environment }}-$(date +%Y%m%d%H%M%S)" \
            --location ${{ env.AZURE_LOCATION }} \
            --template-file infra/main.bicep \
            --parameters environmentName=${{ needs.setup.outputs.environment }} \
            --parameters location=${{ env.AZURE_LOCATION }} \
            --parameters postgresAdminUsername='truepulseadmin' \
            --parameters postgresAdminPassword='${{ secrets.POSTGRES_PASSWORD }}' \
            --parameters jwtSecretKey='${{ secrets.JWT_SECRET_KEY }}' \
            --parameters voteHashSecret='${{ secrets.VOTE_HASH_SECRET }}' \
            --parameters newsDataApiKey='${{ secrets.NEWSDATA_API_KEY }}' \
            --parameters newsApiOrgKey='${{ secrets.NEWSAPI_ORG_KEY }}' \
            --parameters communicationSenderNumber='${{ secrets.COMMUNICATION_SENDER_NUMBER }}' \
            --parameters enableCMK=false \
            --parameters enableCustomDomain=false \
            --parameters sharedLogAnalyticsWorkspaceId='${{ steps.shared.outputs.logAnalyticsWorkspaceId }}' \
            --parameters sharedContainerRegistryName='${{ steps.shared.outputs.containerRegistryName }}' \
            --parameters sharedContainerRegistryLoginServer='${{ steps.shared.outputs.containerRegistryLoginServer }}' \
            --parameters sharedCommunicationServiceConnectionString='${{ steps.shared.outputs.communicationServiceConnectionString }}' \
            --parameters sharedCommunicationServiceName='${{ steps.shared.outputs.communicationServiceName }}' \
            --query 'properties.outputs' \
            --output json)
          
          echo "resourceGroupName=$(echo $DEPLOYMENT_OUTPUT | jq -r '.resourceGroupName.value')" >> $GITHUB_OUTPUT
          echo "acrLoginServer=${{ steps.shared.outputs.containerRegistryLoginServer }}" >> $GITHUB_OUTPUT
          echo "apiFqdn=$(echo $DEPLOYMENT_OUTPUT | jq -r '.containerAppApiFqdn.value')" >> $GITHUB_OUTPUT
          echo "swaHostname=$(echo $DEPLOYMENT_OUTPUT | jq -r '.staticWebAppHostname.value')" >> $GITHUB_OUTPUT
          echo "keyVaultUri=$(echo $DEPLOYMENT_OUTPUT | jq -r '.keyVaultUri.value')" >> $GITHUB_OUTPUT

      - name: Save SWA Deployment Token to Key Vault
        run: |
          # Get the SWA deployment token
          SWA_NAME=$(az resource list \
            --resource-group ${{ steps.deploy.outputs.resourceGroupName }} \
            --resource-type Microsoft.Web/staticSites \
            --query '[0].name' -o tsv)
          
          SWA_TOKEN=$(az staticwebapp secrets list \
            --name $SWA_NAME \
            --resource-group ${{ steps.deploy.outputs.resourceGroupName }} \
            --query 'properties.apiKey' -o tsv)
          
          # Store in Key Vault
          KV_NAME=$(az keyvault list \
            --resource-group ${{ steps.deploy.outputs.resourceGroupName }} \
            --query '[0].name' -o tsv)
          
          az keyvault secret set \
            --vault-name $KV_NAME \
            --name swa-deployment-token \
            --value "$SWA_TOKEN" || true

  # ============================================================================
  # Build and Push Backend Container
  # ============================================================================
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: [setup, infrastructure]
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      imageTag: ${{ steps.meta.outputs.tags }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: |
          az acr login --name ${{ needs.infrastructure.outputs.acrLoginServer }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ needs.infrastructure.outputs.acrLoginServer }}/truepulse-api
          tags: |
            type=sha,prefix=
            type=raw,value=${{ needs.setup.outputs.environment }}
            type=raw,value=latest,enable=${{ needs.setup.outputs.environment == 'prod' }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: src/backend
          file: src/backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            ENVIRONMENT=${{ needs.setup.outputs.environment }}

  # ============================================================================
  # Deploy Backend to Container Apps
  # ============================================================================
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: [setup, infrastructure, build-backend]
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Container Apps
        run: |
          IMAGE_TAG=$(echo "${{ needs.build-backend.outputs.imageTag }}" | head -1)
          CONTAINER_APP_NAME="ca-truepulse-api-${{ needs.setup.outputs.environment }}"
          
          az containerapp update \
            --name $CONTAINER_APP_NAME \
            --resource-group ${{ needs.infrastructure.outputs.resourceGroupName }} \
            --image $IMAGE_TAG

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to complete..."
          sleep 30
          
          CONTAINER_APP_NAME="ca-truepulse-api-${{ needs.setup.outputs.environment }}"
          
          # Check container app status
          STATUS=$(az containerapp show \
            --name $CONTAINER_APP_NAME \
            --resource-group ${{ needs.infrastructure.outputs.resourceGroupName }} \
            --query 'properties.runningStatus' -o tsv)
          
          if [ "$STATUS" != "Running" ]; then
            echo "Deployment may still be in progress. Status: $STATUS"
          fi
          
          echo "Deployment completed!"

      - name: Health check
        run: |
          API_URL="https://${{ needs.infrastructure.outputs.apiFqdn }}"
          
          for i in {1..10}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/health" || echo "000")
            if [ "$HTTP_STATUS" == "200" ]; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $i: HTTP status $HTTP_STATUS, retrying in 10s..."
            sleep 10
          done
          
          echo "Health check failed after 10 attempts"
          exit 1

  # ============================================================================
  # Build and Deploy Frontend
  # ============================================================================
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [setup, infrastructure, deploy-backend]
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/frontend/package-lock.json

      - name: Install dependencies
        working-directory: src/frontend
        run: npm ci

      - name: Build frontend
        working-directory: src/frontend
        env:
          NEXT_PUBLIC_API_URL: https://${{ needs.infrastructure.outputs.apiFqdn }}
          NEXT_PUBLIC_APP_ENV: ${{ needs.setup.outputs.environment }}
        run: npm run build

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get SWA deployment token
        id: swa-token
        run: |
          SWA_NAME=$(az resource list \
            --resource-group ${{ needs.infrastructure.outputs.resourceGroupName }} \
            --resource-type Microsoft.Web/staticSites \
            --query '[0].name' -o tsv)
          
          TOKEN=$(az staticwebapp secrets list \
            --name $SWA_NAME \
            --resource-group ${{ needs.infrastructure.outputs.resourceGroupName }} \
            --query 'properties.apiKey' -o tsv)
          
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Deploy to Static Web App
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa-token.outputs.token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: src/frontend
          output_location: out
          skip_app_build: true

  # ============================================================================
  # Deployment Complete
  # ============================================================================
  deployment-complete:
    name: Deployment Complete
    runs-on: ubuntu-latest
    needs: [setup, infrastructure, deploy-backend, deploy-frontend]
    if: success()
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend:** https://${{ needs.infrastructure.outputs.swaHostname }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API:** https://${{ needs.infrastructure.outputs.apiFqdn }}" >> $GITHUB_STEP_SUMMARY
